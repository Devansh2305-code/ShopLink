<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopLink E-commerce Platform</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK Imports (MUST BE LOADED FIRST) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, setDoc, deleteDoc, runTransaction, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase components globally or via custom setup (important for single-file structure)
        window.firebaseDependencies = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, onSnapshot, collection, setDoc, deleteDoc, runTransaction, query, where, getDocs
        };
    </script>
    
    <style>
        /* Custom styles for aesthetic enhancements */
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease-in-out;
        }
        .card:hover {
            transform: translateY(-3px);
        }
        .input-field {
            /* px-4 py-2 */
            padding: 0.5rem 1rem;
            /* border border-gray-300 */
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            /* w-full */
            width: 100%;
            box-sizing: border-box;
            transition: box-shadow 0.2s ease, border-color 0.2s ease;
        }
        .input-field:focus {
            outline: none;
            /* approximate Tailwind ring + indigo focus */
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.12);
            border-color: #4f46e5;
        }
        .btn-primary {
            /* bg-indigo-600 text-white */
            background-color: #4f46e5;
            color: #ffffff;
            /* px-6 py-3 */
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            /* shadow-md approximation */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-primary:hover {
            /* hover:bg-indigo-700 */
            background-color: #4338ca;
        }
        .text-error {
            /* text-red-600 text-sm mt-1 */
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#10b981',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 font-sans min-h-screen">

    <!-- Header and Navigation -->
    <header class="bg-white shadow-md p-4 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-extrabold text-primary cursor-pointer" onclick="renderApp()">ShopLink</h1>
            <nav id="main-nav" class="flex items-center space-x-4">
                <span id="cart-indicator" class="relative">
                    <!-- Cart indicator renders here -->
                </span>
                <button id="logout-btn" class="text-sm text-gray-600 hover:text-red-500 hidden" onclick="handleLogout()">Logout</button>
            </nav>
        </div>
    </header>

    <main id="app-container" class="max-w-7xl mx-auto p-4 md:p-10">
        <!-- Content will be rendered here by JavaScript -->
    </main>

    <div id="modal-container">
        <!-- Custom Modal for Notifications/Alerts -->
    </div>

    <script type="module">
        // --- FIREBASE CONFIG & INITIALIZATION ---
        
        let db, auth, firestoreDb;
        let userId = null;
        let isAuthReady = false;

        // Global variables provided by the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Destructure Firebase dependencies from the global window object
        const {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, onSnapshot, collection, setDoc, deleteDoc, runTransaction, query, where, getDocs
        } = window.firebaseDependencies;

        if (Object.keys(firebaseConfig).length > 0) {
            db = initializeApp(firebaseConfig);
            auth = getAuth(db);
            firestoreDb = getFirestore(db);
        } else {
             // Mock Firebase for local testing if environment variables are missing
             console.warn("Firebase config not found. Cart features will be non-functional without a hosted environment.");
        }
        
        // --- GLOBAL STATE (Managed by Firestore/API) ---
        
        const API_BASE_URL = 'https://shoplink-api.onrender.com/api'; 
        let currentToken = localStorage.getItem('token') || null;
        let loggedInUser = JSON.parse(localStorage.getItem('user')) || null;
        let loggedInUserType = localStorage.getItem('userType') || null;
        let currentView = 'login'; 

        // Live data from API/Firestore
        let allShops = [];
        let shopProducts = [];
        let ownerProducts = [];
        let ownerOrders = [];
        let ownerAnalytics = { sales: [], details: [] };
        let cartItems = []; // Live cart data from Firestore
        let selectedShopId = null; // Used for customer viewing products

        // --- FIREBASE AUTHENTICATION AND LISTENERS ---

        function setupAuthListener() {
            if (!auth) return;

            onAuthStateChanged(auth, async (user) => {
                isAuthReady = true;

                if (user) {
                    userId = user.uid;
                } else {
                    // Sign in anonymously if no custom token is provided
                    if (!initialAuthToken) {
                        const anonUser = await signInAnonymously(auth);
                        userId = anonUser.user.uid;
                    }
                }
                
                // If a token is stored locally, use that state.
                if (currentToken && loggedInUser && loggedInUserType) {
                    currentView = loggedInUserType;
                    document.getElementById('logout-btn').classList.remove('hidden');
                } else {
                    currentView = 'login';
                    document.getElementById('logout-btn').classList.add('hidden');
                }
                
                // Start listening to the cart (only if customer and authenticated)
                if (loggedInUserType === 'customer' && firestoreDb) {
                    setupCartListener();
                }

                renderApp();
            });

            // Initial custom token sign-in if provided (used by canvas environment)
            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken).catch(error => {
                    console.error("Firebase custom token sign-in failed:", error);
                    // Fallback to anonymous if custom token fails
                    signInAnonymously(auth);
                });
            }
        }

        function setupCartListener() {
            // Cart data is stored publicly under /artifacts/{appId}/public/data/carts/{userId}
            const cartPath = `artifacts/${appId}/public/data/carts/${userId}`;
            const cartRef = doc(firestoreDb, cartPath);

            onSnapshot(cartRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    // Cart document contains an array of items
                    cartItems = docSnapshot.data().items || [];
                } else {
                    cartItems = [];
                }
                // Re-render cart indicator and customer view
                renderCartIndicator();
                if (currentView === 'customer') {
                    // If the customer view is already rendered, update the UI parts that show the cart status
                    renderCustomerDashboard(); 
                }
            }, (error) => {
                console.error("Error setting up cart listener:", error);
            });
        }
        
        // --- UTILITY FUNCTIONS ---

        function showMessage(message, type = 'success') {
            const container = document.getElementById('modal-container');
            const color = type === 'error' ? 'bg-red-500' : 'bg-green-500';

            const modalHtml = `
                <div class="fixed inset-0 z-50 flex items-end justify-center px-4 py-6 pointer-events-none sm:p-6 sm:items-start sm:justify-end">
                    <div class="max-w-sm w-full ${color} text-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden">
                        <div class="p-4">
                            <p class="text-sm font-medium">${message}</p>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML = modalHtml;
            setTimeout(() => {
                container.innerHTML = '';
            }, 3000);
        }
        
        async function secureFetch(endpoint, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };

            if (currentToken) {
                headers['Authorization'] = `Bearer ${currentToken}`;
            }

            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                ...options,
                headers
            });

            const data = await response.json();

            if (!response.ok) {
                showMessage(data.message || `API Error on ${endpoint}`, 'error');
                if (response.status === 401 || response.status === 403) {
                    // Redirect to login on unauthorized access
                    handleLogout();
                }
                return { ok: false, data: data };
            }

            return { ok: true, data: data };
        }


        // --- CART MANAGEMENT (FIRESTORE) ---
        
        // Helper to get cart document reference
        function getCartDocRef() {
             if (!firestoreDb || !userId) {
                showMessage("Database connection or user ID not ready.", 'error');
                return null;
            }
            const cartPath = `artifacts/${appId}/public/data/carts/${userId}`;
            return doc(firestoreDb, cartPath);
        }
        
        async function updateCartInFirestore(newItems) {
            const cartRef = getCartDocRef();
            if (!cartRef) return;

            try {
                await setDoc(cartRef, { items: newItems, userId: loggedInUser.id, updatedAt: Date.now() });
                // Note: The listener (setupCartListener) will automatically update the cartItems array
            } catch (error) {
                showMessage("Failed to update cart in database.", 'error');
                console.error("Firestore update error:", error);
            }
        }

        async function handleAddToCart(product) {
            if (!loggedInUser || loggedInUserType !== 'customer') {
                showMessage('Please log in as a customer to add items to the cart.', 'error');
                return;
            }

            // Find if the item already exists in the cart
            const existingItemIndex = cartItems.findIndex(item => 
                item.productId === product._id && item.shopId === product.shopId
            );

            let newItems = [...cartItems];

            if (existingItemIndex > -1) {
                // Item exists: increase quantity
                newItems[existingItemIndex].quantity += 1;
            } else {
                // New item: add to cart
                newItems.push({
                    productId: product._id,
                    name: product.name,
                    price: product.price,
                    shopId: product.shopId,
                    shopName: allShops.find(s => s._id === product.shopId)?.shopName || 'Unknown Shop',
                    quantity: 1,
                    stockQuantity: product.stockQuantity // For client-side stock checking
                });
            }

            await updateCartInFirestore(newItems);
            showMessage(`${product.name} added to cart!`);
        }

        async function handleRemoveFromCart(productId, shopId) {
            const newItems = cartItems.filter(item => !(item.productId === productId && item.shopId === shopId));
            await updateCartInFirestore(newItems);
            showMessage('Item removed from cart.', 'error');
        }


        // --- STATE MANAGEMENT AND RENDER ---

        function updateAppState(view, token, user, userType) {
            currentToken = token;
            loggedInUser = user;
            loggedInUserType = userType;
            currentView = view;
            
            if (token) {
                localStorage.setItem('token', token);
                localStorage.setItem('user', JSON.stringify(user));
                localStorage.setItem('userType', userType);
                document.getElementById('logout-btn').classList.remove('hidden');
                
                // If switching to customer, set up cart listener
                if (userType === 'customer' && firestoreDb) {
                     setupCartListener();
                }
                
            } else {
                localStorage.clear();
                cartItems = []; // Clear cart state
                document.getElementById('logout-btn').classList.add('hidden');
            }

            renderApp();
        }

        function handleLogout() {
            // Sign out of Firebase (if logged in)
            if (auth && auth.currentUser) {
                auth.signOut();
            }
            updateAppState('login', null, null, null);
            showMessage('Logged out successfully.');
        }
        
        function renderCartIndicator() {
            const indicator = document.getElementById('cart-indicator');
            if (loggedInUserType !== 'customer') {
                indicator.innerHTML = '';
                return;
            }

            const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);

            indicator.innerHTML = `
                <button 
                    onclick="currentView = 'cart'; renderApp();" 
                    class="relative p-2 rounded-full text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                >
                    <!-- Shopping Cart SVG -->
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.2 7m10.8-7l2.2 7M11 18h2m-2 0a2 2 0 100-4 2 2 0 000 4zm7 0a2 2 0 100-4 2 2 0 000 4z" />
                    </svg>
                    ${totalItems > 0 ? `<span class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">${totalItems}</span>` : ''}
                </button>
            `;
        }


        function renderApp() {
            const container = document.getElementById('app-container');
            renderCartIndicator();

            if (!isAuthReady) {
                 container.innerHTML = `<div class="text-center p-10 text-lg">Loading application...</div>`;
                 return;
            }

            // Determine which view to render based on user type
            switch (currentView) {
                case 'login':
                case 'register_customer':
                case 'register_owner':
                    container.innerHTML = renderAuthForm(currentView);
                    attachAuthListeners();
                    break;
                case 'customer':
                    container.innerHTML = renderCustomerDashboard();
                    fetchCustomerData();
                    break;
                case 'shop_products':
                    container.innerHTML = renderShopProductsView();
                    fetchShopProducts(selectedShopId);
                    break;
                case 'cart':
                    container.innerHTML = renderCartView();
                    break;
                case 'owner':
                    container.innerHTML = renderOwnerDashboard();
                    attachOwnerListeners();
                    fetchOwnerProducts();
                    break;
                case 'owner_orders':
                    container.innerHTML = renderOwnerOrders();
                    fetchOwnerOrders();
                    break;
                case 'owner_analytics':
                    container.innerHTML = renderOwnerAnalytics();
                    fetchOwnerAnalytics();
                    break;
                default:
                    container.innerHTML = renderAuthForm('login');
                    attachAuthListeners();
                    break;
            }
        }

        // --- AUTH FORMS ---
        
        // (Authentication form rendering and listeners omitted for brevity in this response, as they were provided previously)
        // ... (The comprehensive rendering and handling functions for login/register go here)
        
        
        // Since we are focused on the final feature, let's include the main functions here for completeness:

        function renderAuthForm(mode) {
             const isRegister = mode.includes('register');
             const isCustomer = mode.includes('customer');
             const title = isRegister ? `New ${isCustomer ? 'Customer' : 'Shop Owner'} Registration` : 'Login';
             const action = isRegister ? 'handleRegistration' : 'handleLogin';
             const userType = isCustomer ? 'customer' : 'owner';

             return `
                 <div class="max-w-md mx-auto card bg-white p-8 rounded-xl shadow-lg">
                     <h2 class="text-3xl font-bold mb-6 text-center text-gray-900">${title}</h2>
                     <form id="${action}-form" data-type="${userType}" onsubmit="event.preventDefault(); window.${action}(event)">
                         
                         ${isCustomer ? `
                             <!-- Customer Fields -->
                             <div class="mb-4"><input name="name" class="input-field" placeholder="Full Name" required></div>
                             ${isRegister ? `
                             <div class="mb-4 grid grid-cols-2 gap-4">
                                 <input type="number" name="age" class="input-field" placeholder="Age">
                                 <select name="gender" class="input-field">
                                     <option value="">Select Gender</option>
                                     <option value="Male">Male</option>
                                     <option value="Female">Female</option>
                                     <option value="Other">Other</option>
                                 </select>
                             </div>
                             <div class="mb-4"><input name="address" class="input-field" placeholder="Delivery Address" required></div>
                             ` : ''}
                             
                             <div class="mb-4"><input type="tel" name="phone" class="input-field" placeholder="10-digit Phone Number (e.g., 9876543210)" pattern="\\d{10}" required></div>
                             
                         ` : `
                             <!-- Shop Owner Fields -->
                             ${isRegister ? `
                             <div class="mb-4"><input name="shopName" class="input-field" placeholder="Shop Name (Unique)" required></div>
                             <div class="mb-4"><input name="ownerName" class="input-field" placeholder="Owner Name" required></div>
                             <div class="mb-4"><input name="registrationId" class="input-field" placeholder="Registration ID (Unique)" required></div>
                             <div class="mb-4"><input type="tel" name="phone" class="input-field" placeholder="10-digit Phone Number (Owner Contact)" pattern="\\d{10}" required></div>
                             <div class="mb-4">
                                 <select name="category" class="input-field" required>
                                     <option value="">Select Shop Category</option>
                                     <option value="Clothing">Clothing</option>
                                     <option value="General Store">General Store</option>
                                     <option value="Accessories">Accessories</option>
                                     <option value="Electronics">Electronics</option>
                                 </select>
                             </div>
                             ` : `<div class="mb-4"><input name="registrationId" class="input-field" placeholder="Shop Registration ID" required></div>`}
                         `}
                         
                         <!-- Common Fields -->
                         <div class="mb-6"><input type="password" name="password" class="input-field" placeholder="Password" required></div>
                         
                         <button type="submit" class="btn-primary w-full">${isRegister ? 'Register' : 'Login'}</button>
                     </form>

                     <div class="mt-6 text-center text-sm">
                         ${!isRegister ? `
                             <p>Don't have an account?</p>
                             <div class="mt-2 space-y-2">
                                 <button onclick="renderApp('register_customer')" class="text-indigo-600 hover:text-indigo-800 font-medium">Register as Customer</button><br>
                                 <button onclick="renderApp('register_owner')" class="text-green-600 hover:text-green-800 font-medium">Register as Shop Owner</button>
                             </div>
                         ` : `
                             <p>Already have an account? <button onclick="renderApp('login')" class="text-indigo-600 hover:text-indigo-800 font-medium">Login Here</button></p>
                         `}
                     </div>
                 </div>
             `;
         }

        function attachAuthListeners() {
            // No direct listeners needed since we use inline onSubmit event handlers
        }
        
        window.handleRegistration = async (event) => {
            const form = event.target;
            const userType = form.dataset.type;
            const endpoint = `/auth/${userType}/register`;
            
            const formData = Object.fromEntries(new FormData(form).entries());
            
            const response = await secureFetch(endpoint, {
                method: 'POST',
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                showMessage(response.data.message);
                renderApp('login'); // Redirect to login after successful registration
            }
        };

        window.handleLogin = async (event) => {
            const form = event.target;
            const userType = form.dataset.type;
            const endpoint = `/auth/${userType}/login`;
            
            const formData = Object.fromEntries(new FormData(form).entries());
            
            // Determine payload based on user type for login
            const payload = userType === 'customer' 
                ? { phone: formData.phone, password: formData.password }
                : { registrationId: formData.registrationId, password: formData.password };

            const response = await secureFetch(endpoint, {
                method: 'POST',
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                const { token, user } = response.data;
                showMessage(response.data.message);
                updateAppState(userType, token, user, userType);
            }
        };

        // --- CUSTOMER DASHBOARD & CART VIEW ---
        
        function renderCustomerDashboard() {
             return `
                 <div class="p-4 md:p-8 bg-white rounded-xl shadow-lg mb-8">
                     <h2 class="text-3xl font-bold text-gray-800 mb-2">Welcome, ${loggedInUser.name || 'Customer'}!</h2>
                     <p class="text-lg text-gray-600">Browse shops and find the perfect product.</p>
                 </div>
                 <div class="grid grid-cols-1 md:grid-cols-4 gap-6" id="shops-list">
                     <div class="md:col-span-4 text-center p-10 text-gray-500">Loading shops...</div>
                 </div>
             `;
         }
         
        async function fetchCustomerData() {
            const response = await secureFetch('/customer/shops');
            if (response.ok) {
                allShops = response.data;
                const shopListContainer = document.getElementById('shops-list');
                shopListContainer.innerHTML = '';

                if (allShops.length === 0) {
                    shopListContainer.innerHTML = `<div class="md:col-span-4 text-center p-10 text-gray-500">No shops are currently registered.</div>`;
                    return;
                }

                allShops.forEach(shop => {
                    shopListContainer.innerHTML += `
                        <div class="card bg-white p-6 rounded-xl border border-gray-200">
                            <h3 class="text-xl font-semibold text-primary">${shop.shopName}</h3>
                            <p class="text-sm text-gray-500">Category: ${shop.category}</p>
                            <p class="mt-4 text-gray-700">Owner: ${shop.ownerName}</p>
                            <button onclick="window.currentView = 'shop_products'; window.selectedShopId = '${shop._id}'; renderApp();" class="mt-4 w-full bg-secondary text-white py-2 rounded-lg hover:bg-green-700 transition">View Products</button>
                        </div>
                    `;
                });
            }
        }
        
        function renderShopProductsView() {
            const shop = allShops.find(s => s._id === selectedShopId) || {};

            return `
                <button onclick="window.currentView = 'customer'; renderApp();" class="text-indigo-600 mb-6 flex items-center">
                    <svg class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Back to Shops
                </button>
                <div class="p-4 md:p-8 bg-white rounded-xl shadow-lg mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">${shop.shopName}</h2>
                    <p class="text-lg text-gray-600">Category: ${shop.category}</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="products-list">
                    <div class="md:col-span-3 text-center p-10 text-gray-500">Loading products...</div>
                </div>
            `;
        }
        
        async function fetchShopProducts(shopId) {
            const response = await secureFetch(`/customer/shops/${shopId}/products`);
            if (response.ok) {
                shopProducts = response.data;
                const listContainer = document.getElementById('products-list');
                listContainer.innerHTML = '';

                if (shopProducts.length === 0) {
                    listContainer.innerHTML = `<div class="md:col-span-3 text-center p-10 text-gray-500">No products listed by this shop yet.</div>`;
                    return;
                }

                shopProducts.forEach(product => {
                    const isInCart = cartItems.find(item => item.productId === product._id);
                    const detailsHtml = product.details ? Object.entries(product.details).map(([key, value]) => `<span class="text-xs bg-gray-100 px-2 py-1 rounded">${key}: ${value}</span>`).join(' ') : '';
                    
                    listContainer.innerHTML += `
                        <div class="card bg-white p-6 rounded-xl border border-gray-200 flex flex-col justify-between">
                            <div>
                                <h3 class="text-xl font-semibold text-gray-800 mb-2">${product.name}</h3>
                                <p class="text-sm text-gray-600 mb-2">${product.description}</p>
                                <div class="flex flex-wrap gap-2 mb-4">${detailsHtml}</div>
                                <p class="text-2xl font-bold text-secondary">â‚¹${product.price.toFixed(2)}</p>
                                <p class="text-sm ${product.stockQuantity > 0 ? 'text-green-600' : 'text-red-600'}">Stock: ${product.stockQuantity > 0 ? product.stockQuantity : 'Out of Stock'}</p>
                            </div>
                            <div class="mt-4">
                                ${product.stockQuantity > 0 ? 
                                    `<button 
                                        onclick="handleAddToCart(${JSON.stringify(product).replace(/'/g, "\\'")})" 
                                        class="w-full ${isInCart ? 'bg-yellow-500' : 'bg-indigo-600'} text-white py-2 rounded-lg hover:opacity-90 transition"
                                        ${isInCart ? `title="Item already in cart"` : ''}
                                    >
                                        ${isInCart ? 'Update Quantity' : 'Add to Cart'}
                                    </button>` 
                                    : `<button disabled class="w-full bg-gray-400 text-white py-2 rounded-lg cursor-not-allowed">Sold Out</button>`
                                }
                            </div>
                        </div>
                    `;
                });
            }
        }
        
        function renderCartView() {
            const total = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            if (cartItems.length === 0) {
                return `
                    <div class="text-center p-10 bg-white rounded-xl shadow-lg">
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">Your Cart is Empty</h2>
                        <p class="text-gray-600">Looks like you haven't added anything yet. <button onclick="window.currentView = 'customer'; renderApp();" class="text-indigo-600 font-medium">Start Shopping!</button></p>
                    </div>
                `;
            }

            // Group items by shop for clear presentation
            const groupedCart = cartItems.reduce((acc, item) => {
                if (!acc[item.shopId]) {
                    acc[item.shopId] = { shopName: item.shopName, items: [], shopTotal: 0 };
                }
                acc[item.shopId].items.push(item);
                acc[item.shopId].shopTotal += item.price * item.quantity;
                return acc;
            }, {});

            let cartHtml = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Your Shopping Cart (${cartItems.length} items)</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Cart Items Column (Col 1 & 2) -->
                    <div class="lg:col-span-2 space-y-6">
            `;
            
            // Render groups of items by shop
            Object.values(groupedCart).forEach(shopGroup => {
                cartHtml += `
                    <div class="card bg-white p-6 rounded-xl border border-gray-200">
                        <h3 class="text-xl font-bold text-primary mb-4">ðŸ›’ ${shopGroup.shopName}</h3>
                        <div class="space-y-4">
                            ${shopGroup.items.map(item => `
                                <div class="flex justify-between items-center border-b pb-3">
                                    <div class="flex-grow">
                                        <p class="font-semibold text-gray-800">${item.name}</p>
                                        <p class="text-sm text-gray-500">â‚¹${item.price.toFixed(2)} x ${item.quantity}</p>
                                    </div>
                                    <div class="flex items-center space-x-4">
                                        <p class="font-bold text-lg text-secondary">â‚¹${(item.price * item.quantity).toFixed(2)}</p>
                                        <button onclick="handleRemoveFromCart('${item.productId}', '${item.shopId}')" class="text-red-500 hover:text-red-700 transition">
                                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.86 10.43a2 2 0 01-1.99 1.57H7.85a2 2 0 01-1.99-1.57L5 7m4 0V5a2 2 0 012-2h2a2 2 0 012 2v2M8 7h8"></path></svg>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            cartHtml += `
                    </div>
                    <!-- Order Summary Column (Col 3) -->
                    <div class="lg:col-span-1">
                        <div class="card bg-white p-6 rounded-xl shadow-2xl sticky top-20">
                            <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-3">Order Summary</h3>
                            <div class="space-y-3 mb-6">
                                <div class="flex justify-between">
                                    <p class="text-gray-600">Subtotal (${cartItems.length} items)</p>
                                    <p class="font-medium">â‚¹${total.toFixed(2)}</p>
                                </div>
                                <div class="flex justify-between border-t pt-3">
                                    <p class="text-xl font-bold text-gray-900">Total Payable</p>
                                    <p class="text-2xl font-extrabold text-secondary">â‚¹${total.toFixed(2)}</p>
                                </div>
                            </div>
                            
                            <!-- Payment Simulation/Checkout -->
                            <form onsubmit="event.preventDefault(); handleCheckout()">
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Simulated Payment Method</label>
                                    <select id="payment-method" class="input-field" required>
                                        <option value="">Select Payment Method</option>
                                        <option value="Card">Credit/Debit Card (Simulated)</option>
                                        <option value="UPI">UPI (Simulated)</option>
                                        <option value="COD">Cash on Delivery (Simulated)</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn-primary w-full py-3">Proceed to Payment (â‚¹${total.toFixed(2)})</button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            return cartHtml;
        }

        window.handleCheckout = async () => {
            if (cartItems.length === 0) {
                showMessage('Cart is empty!', 'error');
                return;
            }

            const paymentMethod = document.getElementById('payment-method').value;
            if (!paymentMethod) {
                showMessage('Please select a payment method.', 'error');
                return;
            }

            showMessage('Processing payment and finalizing order...', 'secondary');

            const orderData = {
                customerId: loggedInUser.id,
                items: cartItems,
                paymentMethod: paymentMethod,
                totalAmount: cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0),
            };

            const response = await secureFetch('/customer/checkout', {
                method: 'POST',
                body: JSON.stringify(orderData)
            });

            if (response.ok) {
                // 1. Clear cart in Firestore on success
                const cartRef = getCartDocRef();
                if (cartRef) {
                    await deleteDoc(cartRef);
                }
                
                showMessage('âœ… Order placed successfully! Stock deducted.', 'success');
                window.currentView = 'customer';
                renderApp();
            } else {
                // Backend error handles stock/validation failures
                showMessage(response.data.message || 'Checkout failed due to server error.', 'error');
            }
        };


        // --- OWNER DASHBOARD VIEWS ---
        
        // (Owner dashboard views and logic omitted for brevity, as they were provided previously)
        // ... (The comprehensive rendering and handling functions for owner dashboard go here)
        
        // Since we are focused on the final feature, let's include the main functions here for completeness:
        
        function renderOwnerDashboard() {
             return `
                 <div class="p-4 md:p-8 bg-white rounded-xl shadow-lg mb-8">
                     <h2 class="text-3xl font-bold text-gray-800 mb-2">Shop Owner Dashboard</h2>
                     <p class="text-lg text-gray-600">Welcome, ${loggedInUser.shopName} (${loggedInUser.registrationId})!</p>
                 </div>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                     <button onclick="window.currentView = 'owner'; renderApp();" class="card p-6 bg-indigo-500 text-white rounded-xl text-left hover:bg-indigo-600">
                         <h3 class="text-xl font-semibold">Manage Products</h3>
                         <p class="text-sm opacity-90">Add, edit, and update inventory.</p>
                     </button>
                     <button onclick="window.currentView = 'owner_orders'; renderApp();" class="card p-6 bg-green-500 text-white rounded-xl text-left hover:bg-green-600">
                         <h3 class="text-xl font-semibold">Manage Orders</h3>
                         <p class="text-sm opacity-90">View and update order statuses.</p>
                     </button>
                     <button onclick="window.currentView = 'owner_analytics'; renderApp();" class="card p-6 bg-yellow-500 text-white rounded-xl text-left hover:bg-yellow-600">
                         <h3 class="text-xl font-semibold">View Analytics</h3>
                         <p class="text-sm opacity-90">Check profit and sales details.</p>
                     </button>
                 </div>
                 <div class="mt-8" id="owner-content">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Your Product Listings</h3>
                    <button onclick="showAddProductModal()" class="btn-primary mb-4">Add New Product</button>
                    <div id="product-list" class="space-y-4">Loading products...</div>
                 </div>
             `;
         }
         
        async function fetchOwnerProducts() {
            const response = await secureFetch('/owner/products');
            const container = document.getElementById('product-list');
            container.innerHTML = '';

            if (response.ok) {
                ownerProducts = response.data;
                if (ownerProducts.length === 0) {
                    container.innerHTML = `<div class="p-4 text-gray-500 border rounded-lg">You haven't added any products yet.</div>`;
                    return;
                }

                ownerProducts.forEach(product => {
                    const detailsHtml = product.details ? Object.entries(product.details).map(([key, value]) => `<span class="text-xs bg-gray-100 px-2 py-1 rounded">${key}: ${value}</span>`).join(' ') : '';

                    container.innerHTML += `
                        <div class="p-4 border rounded-lg bg-white flex justify-between items-center shadow-sm">
                            <div>
                                <h4 class="font-semibold text-lg">${product.name} (${product.category})</h4>
                                <p class="text-sm text-gray-600">Price: â‚¹${product.price.toFixed(2)} | Cost: â‚¹${product.costPrice.toFixed(2)} | Profit: â‚¹${(product.price - product.costPrice).toFixed(2)}</p>
                                <p class="text-sm text-green-600">Stock: ${product.stockQuantity}</p>
                                <div class="flex flex-wrap gap-2 mt-2">${detailsHtml}</div>
                            </div>
                            <div class="space-x-2">
                                <button onclick="showEditProductModal('${product._id}')" class="text-indigo-600 hover:text-indigo-800">Edit</button>
                                <button onclick="handleProductDelete('${product._id}')" class="text-red-500 hover:text-red-700">Delete</button>
                            </div>
                        </div>
                    `;
                });
            } else {
                 container.innerHTML = `<div class="p-4 text-red-500 border rounded-lg">Failed to load products. ${response.data.message}</div>`;
            }
        }
        
        // --- Initialization ---

        window.onload = () => {
             // Set up the Firebase authentication listener
             setupAuthListener();
        };
        
    </script>
</body>
</html>